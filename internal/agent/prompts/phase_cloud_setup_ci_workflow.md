## Phase: Setup CI Workflow

Create (or update) a GitHub Actions workflow that runs Tusk Drift replay on every push/PR using `Use-Tusk/drift-action@v1`.

### Goal

Add a workflow file that:

1. Triggers on pull requests and pushes to default branch.
2. Reuses any project-specific CI preparation needed for replay (for example env file copy, image build, dependency install, app setup).
3. Uses `Use-Tusk/drift-action@v1` instead of manual CLI install/cache/run steps.
4. Uses `TUSK_API_KEY` from secrets.
5. Follows the current action input contract from the action definition (`action.yml`), not assumptions.

### Steps

1. **Check code hosting/CI compatibility first**
   - Read `state.code_hosting_type` from current state, or briefly explore the codebase.
   - If it is NOT `github` (for example `gitlab`, or user indicates CircleCI/Jenkins/other CI), SKIP GitHub workflow file generation in this phase.
   - In that skip case, tell the user they should configure their CI manually with:
     - Install CLI (for example `curl -fsSL https://cli.usetusk.ai/install.sh | sh`)
     - Run replay command: `tusk run -c -p --ci --validate-suite-if-default-branch`
     - Set `TUSK_API_KEY` in their CI secrets/environment
   - Then transition with:
     - `ci_workflow_configured`: false
     - `ci_workflow_path`: ``

2. **Inspect existing workflows**
   - Look in `.github/workflows/` (usually in the repo root, if the current service directory doesn't have it) for relevant CI workflow patterns.
   - Prefer matching existing conventions in this repo (naming, triggers, setup steps, style).

3. **Detect replay prerequisites**
   - If existing workflows include setup needed before tests (for example Docker buildx/bake, env copy, dependency install), include those before the Drift step.
   - Keep only what is needed for replay to start and run the app/tests. If it's not a Docker setup, it is likely that we DO NOT need to include any external services like Postgres, Redis, etc -- only what is needed to start the service itself.

4. **Fetch action docs/contract (authoritative first)**
   - Use `http_request` to fetch:
     - `https://raw.githubusercontent.com/Use-Tusk/drift-action/v1/action.yml` (authoritative input contract)
     - optionally: `https://raw.githubusercontent.com/Use-Tusk/drift-action/v1/README.md` (usage examples)
   - If remote fetch fails, continue with the minimal known-good snippet below.
   - Prefer `action.yml` over README when there is any mismatch.

5. **Create or update workflow**
   - If a Tusk Drift workflow already exists, update it to use `Use-Tusk/drift-action@v1`.
   - Otherwise create `.github/workflows/tusk-drift.yml`.
   - For newly created workflows, add this comment block at the top of the file:

      ```yaml
      # NOTE: This workflow is an initial draft generated by Tusk setup.
      # Please validate it in your repo CI and adjust app-specific setup after merge.
      ```

   - Use this shape for the Drift step:

      ```yaml
      - name: Run Tusk Drift trace tests
        uses: Use-Tusk/drift-action@v1
        with:
          cache-key: ${{ runner.os }}-tusk-drift-${{ hashFiles('.tusk/config.yaml') }}
          api-key: ${{ secrets.TUSK_API_KEY }}
      ```

6. **Important behavior requirements**
   - Do not add manual `curl ... install.sh`, manual `actions/cache`, or direct `tusk run` commands if using `drift-action`.
   - Keep `actions/checkout` in the workflow.
   - If the service runs from a subdirectory, set `working-directory` input on the Drift action.
   - Do not hardcode API keys; always use `${{ secrets.TUSK_API_KEY }}`.
   - Keep action configuration minimal by default:
     - Do not set `cli-source` unless there is a clear reason.
     - If `cli-source` is explicitly needed, default to `release` (do not use `source` in normal customer workflows).
     - Avoid tweaking advanced inputs unless required by the repo.

7. **Show the result to the user**
   - Print the final workflow path and key snippet so the user can review quickly.
   - Mention any assumptions you made.

8. **Transition**
   - Call `transition_phase` with:
     - `ci_workflow_configured`: true/false
     - `ci_workflow_path`: created/updated workflow path (if any)

### Important Notes

- Replay often works without external dependencies because outbound calls are mocked from traces, but still preserve any setup that the app needs to boot in CI.
- Prefer minimal, reliable setup over copying unrelated heavy steps.
